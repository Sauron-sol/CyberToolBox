from fastapi import APIRouter, File, UploadFile
from fastapi.responses import JSONResponse
from core.analyzer import MalwareAnalyzer
from core.reporter import SandboxReporter
from config.sandbox_config import SandboxConfig

# Create API router
router = APIRouter()

@router.post("/analyze")
async def analyze_file(file: UploadFile = File(...)):
    """Entry point for file analysis"""
    try:
        analyzer = MalwareAnalyzer()
        reporter = SandboxReporter(SandboxConfig)
        
        # Analyze file
        results = await analyzer.analyze_sample(file.file)
        
        # Generate report
        sample_info = {
            'filename': file.filename,
            'size': 0,  # Will be updated when file is saved
            'content_type': file.content_type
        }
        
        report = await reporter.generate_report(results, sample_info)
        return JSONResponse(content=report)
        
    except Exception as e:
        return JSONResponse(
            status_code=500,
            content={"error": str(e)}
        )

@router.get("/status")
async def get_status():
    """Check API status"""
    return {"status": "running"}
